<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>ğŸ“Š Exportar y Gestionar Asistencias</title>
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
Â  Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJj7QhYJqQ1dM4gB5/Wp12/93A8B08A0Wl77P9x6UeH3O8U15K9Zf/G4J0z9A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
Â  <style>
Â  Â  body { font-family: 'Inter', sans-serif; }
Â  Â  /* Clase para el spinner de carga */
Â  Â  .spinner {
Â  Â  Â  animation: spin 1s linear infinite;
Â  Â  }
Â  Â  @keyframes spin {
Â  Â  Â  from { transform: rotate(0deg); }
Â  Â  Â  to { transform: rotate(360deg); }
Â  Â  }
    /* Estilo especÃ­fico para los inputs de fecha/hora */
    input[type="date"], input[type="time"] {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        cursor: pointer;
    }
Â  </style>
Â  <script type="module">
Â  Â  // Importar funciones de Firebase.
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
Â  Â  import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

Â  Â  // Â¡IMPORTANTE! Usa la misma configuraciÃ³n que tu app de asistencia
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyCxTeZ8LvP4YMKCV3Ter2n1_Wej0ezYgBQ",
Â  Â  Â  authDomain: "asistencia-d15e0.firebaseapp.com",
Â  Â  Â  projectId: "asistencia-d15e0",
Â  Â  Â  storageBucket: "asistencia-d15e0.firebasestorage.app",
Â  Â  Â  messagingSenderId: "588035080507",
Â  Â  Â  appId: "1:588035080507:web:76ff418bb86fccafb0b71e",
Â  Â  Â  measurementId: "G-7XQHD1MG9G"
Â  Â  };

Â  Â  // Inicializar Firebase
Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const db = getFirestore(app);

Â  Â  // ğŸ†• FunciÃ³n para parsear tu formato de fecha a un objeto Date de JavaScript.
    function parseCustomDate(dateString) {
        // Ejemplo de formato: "28 oct 2025, 12:05 p. m."
        
        // Mapeo de meses de espaÃ±ol a inglÃ©s (necesario para el constructor Date)
        const monthMap = {
            'ene': 'Jan', 'feb': 'Feb', 'mar': 'Mar', 'abr': 'Apr',
            'may': 'May', 'jun': 'Jun', 'jul': 'Jul', 'ago': 'Aug',
            'sep': 'Sep', 'oct': 'Oct', 'nov': 'Nov', 'dic': 'Dec'
        };

        // Reemplazar el mes en espaÃ±ol con el mes en inglÃ©s
        let cleanedString = dateString.toLowerCase();
        for (const [es, en] of Object.entries(monthMap)) {
            if (cleanedString.includes(es)) {
                cleanedString = cleanedString.replace(es, en);
                break;
            }
        }
        
        // Reemplazar 'a. m.' y 'p. m.' por 'AM' y 'PM'
        cleanedString = cleanedString.replace('a. m.', 'AM').replace('p. m.', 'PM').replace(',', '');
        
        // Intentar crear un objeto Date. 
        // Â¡Esto es sensible a la configuraciÃ³n regional del navegador!
        const date = new Date(cleanedString);
        
        // Si el parseo falla (Date devuelve Invalid Date), usamos un mÃ©todo mÃ¡s manual
        if (isNaN(date)) {
            console.warn("Fallo al parsear con constructor Date:", dateString);
            // PodrÃ­as intentar una lÃ³gica de parseo mÃ¡s robusta aquÃ­ si es necesario.
        }

        return date;
    }

Â  Â  // FunciÃ³n auxiliar para actualizar el contenido del botÃ³n con un spinner
Â  Â  function updateButtonContent(button, text, isLoading, iconClass = '') {
Â  Â  Â  button.disabled = isLoading;
Â  Â  Â  button.innerHTML = isLoading 
Â  Â  Â  Â  ? `<i class="fas fa-spinner spinner mr-2"></i> Cargando...`
Â  Â  Â  Â  : `<i class="${iconClass} mr-2"></i> ${text}`;
Â  Â  }

    // FunciÃ³n para limpiar los campos de fecha y hora
    function resetFilters() {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('startTime').value = ''; 
        document.getElementById('endTime').value = '';   
        document.getElementById('loadButton').click(); 
    }

Â  Â  // --- LÃ³gica para cargar y mostrar datos (FILTRANDO EN JAVASCRIPT) ---
Â  Â  async function cargarAsistencias() {
Â  Â  Â  const loadButton = document.getElementById('loadButton');
Â  Â  Â  const copyButton = document.getElementById('copyButton');
Â  Â  Â  const resultsDiv = document.getElementById('results');
Â  Â  Â  const messageDiv = document.getElementById('message');
Â  Â  Â  const totalCountSpan = document.getElementById('totalCount');

Â  Â  Â  updateButtonContent(loadButton, 'Cargar Asistencias', true);
Â  Â  Â  resultsDiv.innerHTML = '';
Â  Â  Â  messageDiv.classList.add('hidden');
Â  Â  Â  totalCountSpan.textContent = ''; 
Â  Â  Â  copyButton.classList.add('hidden'); 

      // 1. Obtener los filtros ingresados por el usuario.
      const startDateInput = document.getElementById('startDate').value; // YYYY-MM-DD
      const endDateInput = document.getElementById('endDate').value;     // YYYY-MM-DD
      const startTimeInput = document.getElementById('startTime').value; // HH:mm
      const endTimeInput = document.getElementById('endTime').value;     // HH:mm

      // 2. Crear objetos Date para los lÃ­mites del filtro.
      let filterStart = null;
      let filterEnd = null;

      if (startDateInput) {
          // Crea la fecha de inicio con la hora de inicio (si estÃ¡ presente)
          const startDateTimeString = startDateInput + (startTimeInput ? `T${startTimeInput}:00` : 'T00:00:00');
          filterStart = new Date(startDateTimeString);
      }

      if (endDateInput) {
          // Crea la fecha de fin con la hora de fin (si estÃ¡ presente)
          // Si no hay hora, se usa el Ãºltimo segundo del dÃ­a (23:59:59)
          const endDateTimeString = endDateInput + (endTimeInput ? `T${endTimeInput}:59` : 'T23:59:59');
          filterEnd = new Date(endDateTimeString);
      }
      
Â  Â  Â  try {
Â  Â  Â  Â  // 3. Cargar TODOS los datos de Firebase (sin filtros de query).
Â  Â  Â  Â  const querySnapshot = await getDocs(collection(db, "asistencias"));
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (querySnapshot.empty) {
Â  Â  Â  Â  Â  messageDiv.textContent = 'No se encontraron registros de asistencia.';
Â  Â  Â  Â  Â  messageDiv.classList.remove('hidden');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

        const allData = [];
        querySnapshot.forEach((doc) => {
            allData.push(doc.data());
        });

        // 4. Filtrar los datos cargados en JavaScript.
        const filteredData = allData.filter(data => {
            const entryDate = parseCustomDate(data.fechaHora);
            
            // Si el parseo falla (Invalid Date), lo excluimos
            if (isNaN(entryDate.getTime())) {
                console.error("Registro con fecha invÃ¡lida omitido:", data.fechaHora);
                return false; 
            }

            let passStart = true;
            let passEnd = true;

            if (filterStart) {
                passStart = entryDate.getTime() >= filterStart.getTime();
            }

            if (filterEnd) {
                passEnd = entryDate.getTime() <= filterEnd.getTime();
            }

            return passStart && passEnd;
        });

Â  Â  Â  Â  // 5. Renderizar los datos filtrados.
Â  Â  Â  Â  const totalRegistros = filteredData.length;
Â  Â  Â  Â  totalCountSpan.textContent = `Total: ${totalRegistros}`;

Â  Â  Â  Â  if (filteredData.length === 0) {
Â  Â  Â  Â  Â  messageDiv.textContent = 'No se encontraron registros de asistencia con el filtro aplicado.';
Â  Â  Â  Â  Â  messageDiv.classList.remove('hidden');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  let formattedData = "Nombre;Email;Fecha y Hora\n";
Â  Â  Â  Â  let htmlData = `
Â  Â  Â  Â  Â  <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
Â  Â  Â  Â  Â  <table class="min-w-full divide-y divide-gray-200">
Â  Â  Â  Â  Â  Â  <thead class="bg-blue-100"><tr>
Â  Â  Â  Â  Â  Â  Â  <th class="px-6 py-3 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">Nombre</th>
Â  Â  Â  Â  Â  Â  Â  <th class="px-6 py-3 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">Email</th>
Â  Â  Â  Â  Â  Â  Â  <th class="px-6 py-3 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">Fecha y Hora</th>
Â  Â  Â  Â  Â  Â  </tr></thead>
Â  Â  Â  Â  Â  Â  <tbody class="bg-white divide-y divide-gray-100">
Â  Â  Â  Â  `;

Â  Â  Â  Â  filteredData.forEach((data) => {
Â  Â  Â  Â  Â  formattedData += `"${data.nombre}";"${data.email}";"${data.fechaHora}"\n`;
Â  Â  Â  Â  Â  htmlData += `<tr>
Â  Â  Â  Â  Â  Â  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.nombre}</td>
Â  Â  Â  Â  Â  Â  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.email}</td>
Â  Â  Â  Â  Â  Â  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.fechaHora}</td>
Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  });

Â  Â  Â  Â  htmlData += `</tbody></table></div>`;
Â  Â  Â  Â  resultsDiv.innerHTML = htmlData;
Â  Â  Â  Â  resultsDiv.dataset.csv = formattedData;
Â  Â  Â  Â  copyButton.classList.remove('hidden');

Â  Â  Â  } catch (error) {
Â  Â  Â  Â  messageDiv.textContent = 'Error al cargar los datos: ' + error.message;
Â  Â  Â  Â  messageDiv.classList.remove('hidden');
Â  Â  Â  Â  totalCountSpan.textContent = ''; 
Â  Â  Â  Â  console.error("Error fetching documents: ", error);
Â  Â  Â  } finally {
Â  Â  Â  Â  updateButtonContent(loadButton, 'Cargar Asistencias', false, 'fas fa-download');
Â  Â  Â  }
Â  Â  }

Â  Â  // --- LÃ³gica de Copiar y Eliminar (sin cambios) ---
    function copiarDatos() {
Â  Â  Â  Â  const resultsDiv = document.getElementById('results');
Â  Â  Â  Â  const copyButton = document.getElementById('copyButton');
Â  Â  Â  Â  const csvData = resultsDiv.dataset.csv;
Â  Â  Â  Â  const textArea = document.createElement("textarea");
Â  Â  Â  Â  textArea.value = csvData;
Â  Â  Â  Â  document.body.appendChild(textArea);
Â  Â  Â  Â  textArea.select();
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  document.execCommand('copy');
Â  Â  Â  Â  Â  Â  copyButton.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Â¡Copiado!';
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  console.error('No se pudo copiar', err);
Â  Â  Â  Â  }
Â  Â  Â  Â  document.body.removeChild(textArea);
Â  Â  Â  Â  setTimeout(() => { 
Â  Â  Â  Â  Â  copyButton.innerHTML = '<i class="fas fa-copy mr-2"></i> Copiar como CSV';
Â  Â  Â  Â  }, 2000);
Â  Â  }

Â  Â  async function eliminarAsistencias() {
Â  Â  Â  const password = prompt("ğŸš¨ ATENCIÃ“N: Para eliminar todos los registros, por favor ingrese la contraseÃ±a de administrador:");

Â  Â  Â  if (password === null) return; 

Â  Â  Â  if (password === "fcs2160") {
Â  Â  Â  Â  const confirmacion = confirm("âš ï¸ Â¿EstÃ¡s SEGURO de que quieres eliminar TODAS las asistencias? Esta acciÃ³n no se puede deshacer.");
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (confirmacion) {
Â  Â  Â  Â  Â  const deleteButton = document.getElementById('deleteButton');
Â  Â  Â  Â  Â  const resultsDiv = document.getElementById('results');
Â  Â  Â  Â  Â  const messageDiv = document.getElementById('message');
Â  Â  Â  Â  Â  const totalCountSpan = document.getElementById('totalCount');

Â  Â  Â  Â  Â  deleteButton.disabled = true;
Â  Â  Â  Â  Â  deleteButton.innerHTML = '<i class="fas fa-trash spinner mr-2"></i> Eliminando...';
Â  Â  Â  Â  Â  messageDiv.classList.add('hidden');

Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const querySnapshot = await getDocs(collection(db, "asistencias"));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (querySnapshot.empty) {
Â  Â  Â  Â  Â  Â  Â  messageDiv.textContent = 'La base de datos ya estÃ¡ vacÃ­a.';
Â  Â  Â  Â  Â  Â  Â  messageDiv.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const deletePromises = [];
Â  Â  Â  Â  Â  Â  querySnapshot.forEach((docSnapshot) => {
Â  Â  Â  Â  Â  Â  Â  deletePromises.push(deleteDoc(doc(db, "asistencias", docSnapshot.id)));
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  await Promise.all(deletePromises);

Â  Â  Â  Â  Â  Â  resultsDiv.innerHTML = '';
Â  Â  Â  Â  Â  Â  document.getElementById('copyButton').classList.add('hidden');
Â  Â  Â  Â  Â  Â  messageDiv.className = "p-4 mb-8 text-sm font-medium rounded-lg border bg-green-100 border-green-500 text-green-800";
Â  Â  Â  Â  Â  Â  messageDiv.textContent = 'âœ… Â¡Todas las asistencias han sido eliminadas correctamente!';
Â  Â  Â  Â  Â  Â  totalCountSpan.textContent = 'Total: 0'; 

Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  messageDiv.className = "p-4 mb-8 text-sm font-medium rounded-lg border bg-red-100 border-red-500 text-red-800";
Â  Â  Â  Â  Â  Â  messageDiv.textContent = 'âŒ Error al eliminar los datos: ' + error.message;
Â  Â  Â  Â  Â  Â  console.error("Error deleting documents: ", error);
Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  deleteButton.disabled = false;
Â  Â  Â  Â  Â  Â  deleteButton.innerHTML = '<i class="fas fa-eraser mr-2"></i> Eliminar asistencias';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  alert("ContraseÃ±a incorrecta. No se realizaron cambios.");
Â  Â  Â  }
Â  Â  }

Â  Â  // Asignar eventos a los botones
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  document.getElementById('loadButton').addEventListener('click', cargarAsistencias);
Â  Â  Â  document.getElementById('copyButton').addEventListener('click', copiarDatos);
Â  Â  Â  document.getElementById('deleteButton').addEventListener('click', eliminarAsistencias);
      document.getElementById('resetFilterButton').addEventListener('click', resetFilters); // Evento para limpiar filtros
      
      // Establecer los iconos iniciales en los botones
      document.getElementById('loadButton').innerHTML = '<i class="fas fa-download mr-2"></i> Cargar Asistencias';
      document.getElementById('copyButton').innerHTML = '<i class="fas fa-copy mr-2"></i> Copiar como CSV';
      document.getElementById('deleteButton').innerHTML = '<i class="fas fa-eraser mr-2"></i> Eliminar asistencias';
Â  Â  });
Â  </script>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">
Â  <div class="max-w-5xl mx-auto bg-white p-8 rounded-xl shadow-2xl border border-gray-200">
Â  Â  
Â  Â  Â  Â  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4">
Â  Â  Â  <h1 class="text-3xl font-extrabold text-gray-800 flex items-center">
Â  Â  Â  Â  <i class="fas fa-chart-bar text-blue-500 mr-3"></i> GestiÃ³n de Asistencias
Â  Â  Â  </h1>
Â  Â  Â  <span id="totalCount" class="text-2xl font-bold text-blue-600 mt-2 sm:mt-0 px-4 py-1 bg-blue-50 rounded-lg border border-blue-200"></span> 
Â  Â  </div>

Â  Â  Â  Â  <p class="text-gray-600 mb-8">Esta herramienta te permite **exportar y gestionar** los datos de asistencia de tu base de datos en Firebase Firestore. La exportaciÃ³n se realiza en formato CSV, ideal para hojas de cÃ¡lculo.</p>
Â  Â 
    <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-200 shadow-md mb-8">
        <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
            <i class="fas fa-calendar-alt text-yellow-600 mr-2"></i> Filtrar por Fecha y Hora
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-end">
            <div>
                <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha Desde:</label>
                <input type="date" id="startDate" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm">
            </div>
            <div>
                <label for="startTime" class="block text-sm font-medium text-gray-700 mb-1">Hora Desde:</label>
                <input type="time" id="startTime" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm">
            </div>

            <div>
                <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha Hasta:</label>
                <input type="date" id="endDate" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm">
            </div>
            <div>
                <label for="endTime" class="block text-sm font-medium text-gray-700 mb-1">Hora Hasta:</label>
                <input type="time" id="endTime" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm">
            </div>
        </div>
        
        <div class="flex justify-start mt-4">
             <button id="resetFilterButton" class="flex items-center justify-center bg-gray-500 text-white font-semibold py-2 px-4 rounded-xl hover:bg-gray-600 transition duration-300 transform hover:scale-105 shadow-md">
                <i class="fas fa-undo mr-2"></i> Limpiar Filtros
            </button>
        </div>
        <p class="text-sm text-gray-500 mt-3 italic">Selecciona el rango de tiempo y haz clic en "Cargar Asistencias" para aplicar el filtro.</p>
    </div>
    
Â  Â  Â  Â  <div class="flex flex-wrap items-center gap-4 mb-10 p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-inner">
Â  Â  Â  Â  Â  Â  <button id="loadButton" class="flex items-center justify-center bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition duration-300 transform hover:scale-105 shadow-lg shadow-blue-300/50">
Â  Â  Â  </button>
Â  Â  Â  
Â  Â  Â  Â  Â  Â  <button id="copyButton" class="hidden flex items-center justify-center bg-green-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-green-700 transition duration-300 transform hover:scale-105 shadow-lg shadow-green-300/50">
Â  Â  Â  </button>
Â  Â  Â  
Â  Â  Â  Â  Â  Â  <button id="deleteButton" class="flex items-center justify-center bg-red-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-red-700 transition duration-300 transform hover:scale-105 shadow-lg shadow-red-300/50 ml-auto">
Â  Â  Â  </button>
Â  Â  </div>

Â  Â  Â  Â  <div id="message" class="hidden p-4 mb-8 text-sm font-medium rounded-lg border"></div>

Â  Â  Â  Â  <div id="results" class="overflow-x-auto mt-8">
Â  Â  </div>
Â  </div>
</body>
</html>
