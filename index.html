<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>📊 Exportar y Gestionar Asistencias</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJj7QhYJqQ1dM4gB5/Wp12/93A8B08A0Wl77P9x6UeH3O8U15K9Zf/G4J0z9A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* Clase para el spinner de carga */
    .spinner {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
  <script type="module">
    // Importar funciones de Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // ¡IMPORTANTE! Usa la misma configuración que tu app de asistencia
    const firebaseConfig = {
      apiKey: "AIzaSyCxTeZ8LvP4YMKCV3Ter2n1_Wej0ezYgBQ",
      authDomain: "asistencia-d15e0.firebaseapp.com",
      projectId: "asistencia-d15e0",
      storageBucket: "asistencia-d15e0.firebasestorage.app",
      messagingSenderId: "588035080507",
      appId: "1:588035080507:web:76ff418bb86fccafb0b71e",
      measurementId: "G-7XQHD1MG9G"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Función auxiliar para actualizar el contenido del botón con un spinner
    function updateButtonContent(button, text, isLoading, iconClass = '') {
      button.disabled = isLoading;
      button.innerHTML = isLoading 
        ? `<i class="fas fa-spinner spinner mr-2"></i> Cargando...`
        : `<i class="${iconClass} mr-2"></i> ${text}`;
    }

    // --- Lógica para cargar y mostrar datos ---
    async function cargarAsistencias() {
      const loadButton = document.getElementById('loadButton');
      const copyButton = document.getElementById('copyButton');
      const resultsDiv = document.getElementById('results');
      const messageDiv = document.getElementById('message');
      const totalCountSpan = document.getElementById('totalCount');

      updateButtonContent(loadButton, 'Cargar Asistencias', true);
      resultsDiv.innerHTML = '';
      messageDiv.classList.add('hidden');
      totalCountSpan.textContent = ''; 
      copyButton.classList.add('hidden'); // Ocultar copiar al iniciar carga

      try {
        const querySnapshot = await getDocs(collection(db, "asistencias"));
        
        const totalRegistros = querySnapshot.size;
        totalCountSpan.textContent = `Total: ${totalRegistros}`;

        if (querySnapshot.empty) {
          messageDiv.textContent = 'No se encontraron registros de asistencia.';
          messageDiv.classList.remove('hidden');
          return;
        }

        let formattedData = "Nombre;Email;Fecha y Hora\n";
        let htmlData = `
          <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-blue-100"><tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">Nombre</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">Email</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">Fecha y Hora</th>
            </tr></thead>
            <tbody class="bg-white divide-y divide-gray-100">
