<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>📊 Exportar y Gestionar Asistencias</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJj7QhYJqQ1dM4gB5/Wp12/93A8B08A0Wl77P9x6UeH3O8U15K9Zf/G4J0z9A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* Clase para el spinner de carga */
    .spinner {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    /* Estilo específico para los inputs de fecha/hora */
    input[type="date"], input[type="time"] {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        cursor: pointer;
    }
  </style>
  <script type="module">
    // Importar funciones de Firebase.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // ¡IMPORTANTE! Usa la misma configuración que tu app de asistencia
    const firebaseConfig = {
      apiKey: "AIzaSyCxTeZ8LvP4YMKCV3Ter2n1_Wej0ezYgBQ",
      authDomain: "asistencia-d15e0.firebaseapp.com",
      projectId: "asistencia-d15e0",
      storageBucket: "asistencia-d15e0.firebasestorage.app",
      messagingSenderId: "588035080507",
      appId: "1:588035080507:web:76ff418bb86fccafb0b71e",
      measurementId: "G-7XQHD1MG9G"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 🆕 Función para parsear tu formato de fecha a un objeto Date de JavaScript.
    function parseCustomDate(dateString) {
        // Ejemplo de formato: "28 oct 2025, 12:05 p. m."
        
        // Mapeo de meses de español a inglés (necesario para el constructor Date)
        const monthMap = {
            'ene': 'Jan', 'feb': 'Feb', 'mar': 'Mar', 'abr': 'Apr',
            'may': 'May', 'jun': 'Jun', 'jul': 'Jul', 'ago': 'Aug',
            'sep': 'Sep', 'oct': 'Oct', 'nov': 'Nov', 'dic': 'Dec'
        };

        // Reemplazar el mes en español con el mes en inglés
        let cleanedString = dateString.toLowerCase();
        for (const [es, en] of Object.entries(monthMap)) {
            if (cleanedString.includes(es)) {
                cleanedString = cleanedString.replace(es, en);
                break;
            }
        }
        
        // Reemplazar 'a. m.' y 'p. m.' por 'AM' y 'PM'
        cleanedString = cleanedString.replace('a. m.', 'AM').replace('p. m.', 'PM').replace(',', '');
        
        // Intentar crear un objeto Date. 
        // ¡Esto es sensible a la configuración regional del navegador!
        const date = new Date(cleanedString);
        
        // Si el parseo falla (Date devuelve Invalid Date), usamos un método más manual
        if (isNaN(date)) {
            console.warn("Fallo al parsear con constructor Date:", dateString);
            // Podrías intentar una lógica de parseo más robusta aquí si es necesario.
        }

        return date;
    }

    // Función auxiliar para actualizar el contenido del botón con un spinner
    function updateButtonContent(button, text, isLoading, iconClass = '') {
      button.disabled = isLoading;
      button.innerHTML = isLoading 
        ? `<i class="fas fa-spinner spinner mr-2"></i> Cargando...`
        : `<i class="${iconClass} mr-2"></i> ${text}`;
    }

    // Función para limpiar los campos de fecha y hora
    function resetFilters() {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('startTime').value = ''; 
        document.getElementById('endTime').value = '';   
        document.getElementById('loadButton').click(); 
    }

    // --- Lógica para cargar y mostrar datos (FILTRANDO EN JAVASCRIPT) ---
    async function cargarAsistencias() {
      const loadButton = document.getElementById('loadButton');
      const copyButton = document.getElementById('copyButton');
      const resultsDiv = document.getElementById('results');
      const messageDiv = document.getElementById('message');
      const totalCountSpan = document.getElementById('totalCount');

      updateButtonContent(loadButton, 'Cargar Asistencias', true);
      resultsDiv.innerHTML = '';
      messageDiv.classList.add('hidden');
      totalCountSpan.textContent = ''; 
      copyButton.classList.add('hidden'); 

      // 1. Obtener los filtros ingresados por el usuario.
      const startDateInput = document.getElementById('startDate').value; // YYYY-MM-DD
      const endDateInput = document.getElementById('endDate').value;     // YYYY-MM-DD
      const startTimeInput = document.getElementById('startTime').value; // HH:mm
      const endTimeInput = document.getElementById('endTime').value;     // HH:mm

      // 2. Crear objetos Date para los límites del filtro.
      let filterStart = null;
      let filterEnd = null;

      if (startDateInput) {
          // Crea la fecha de inicio con la hora de inicio (si está presente)
          const startDateTimeString = startDateInput + (startTimeInput ? `T${startTimeInput}:00` : 'T00:00:00');
          filterStart = new Date(startDateTimeString);
      }

      if (endDateInput) {
          // Crea la fecha de fin con la hora de fin (si está presente)
          // Si no hay hora, se usa el último segundo del día (23:59:59)
          const endDateTimeString = endDateInput + (endTimeInput ? `T${endTimeInput}:59` : 'T23:59:59');
          filterEnd = new Date(endDateTimeString);
      }
      
      try {
        // 3. Cargar TODOS los datos de Firebase (sin filtros de query).
        const querySnapshot = await getDocs(collection(db, "asistencias"));
        
        if (querySnapshot.empty) {
          messageDiv.textContent = 'No se encontraron registros de asistencia.';
          messageDiv.classList.remove('hidden');
          return;
        }

        const allData = [];
        querySnapshot.forEach((doc) => {
            allData.push(doc.data());
        });

        // 4. Filtrar los datos cargados en JavaScript.
        const filteredData = allData.filter(data => {
            const entryDate = parseCustomDate(data.fechaHora);
            
            // Si el parseo falla (Invalid Date), lo excluimos
            if (isNaN(entryDate.getTime())) {
                console.error("Registro con fecha inválida omitido:", data.fechaHora);
                return false; 
            }

            let passStart = true;
            let passEnd = true;

            if (filterStart) {
                passStart = entryDate.getTime() >= filterStart.getTime();
            }

            if (filterEnd) {
                passEnd = entryDate.getTime() <= filterEnd.getTime();
            }

            return passStart && passEnd;
        });

        // 5. Renderizar los datos filtrados.
        const totalRegistros = filteredData.length;
        totalCountSpan.textContent = `Total: ${totalRegistros}`;

        if (filteredData.length === 0) {
          messageDiv.textContent = 'No se encontraron registros de asistencia con el filtro aplicado.';
          messageDiv.classList.remove('hidden');
          return;
        }

        let formattedData = "Nombre;Email;Fecha y Hora\n";
        let htmlData = `
          <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-blue-100"><tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">Nombre</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">Email</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-blue-800 uppercase tracking-wider">Fecha y Hora</th>
            </tr></thead>
            <tbody class="bg-white divide-y divide-gray-100">
        `;

        filteredData.forEach((data) => {
          formattedData += `"${data.nombre}";"${data.email}";"${data.fechaHora}"\n`;
          htmlData += `<tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.nombre}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.email}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.fechaHora}</td>
          </tr>`;
        });

        htmlData += `</tbody></table></div>`;
        resultsDiv.innerHTML = htmlData;
        resultsDiv.dataset.csv = formattedData;
        copyButton.classList.remove('hidden');

      } catch (error) {
        messageDiv.textContent = 'Error al cargar los datos: ' + error.message;
        messageDiv.classList.remove('hidden');
        totalCountSpan.textContent = ''; 
        console.error("Error fetching documents: ", error);
      } finally {
        updateButtonContent(loadButton, 'Cargar Asistencias', false, 'fas fa-download');
      }
    }

    // --- Lógica de Copiar y Eliminar (sin cambios) ---
    function copiarDatos() {
        const resultsDiv = document.getElementById('results');
        const copyButton = document.getElementById('copyButton');
        const csvData = resultsDiv.dataset.csv;
        const textArea = document.createElement("textarea");
        textArea.value = csvData;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            copyButton.innerHTML = '<i class="fas fa-check-circle mr-2"></i> ¡Copiado!';
        } catch (err) {
            console.error('No se pudo copiar', err);
        }
        document.body.removeChild(textArea);
        setTimeout(() => { 
          copyButton.innerHTML = '<i class="fas fa-copy mr-2"></i> Copiar como CSV';
        }, 2000);
    }

    async function eliminarAsistencias() {
      const password = prompt("🚨 ATENCIÓN: Para eliminar todos los registros, por favor ingrese la contraseña de administrador:");

      if (password === null) return; 

      if (password === "fcs2160") {
        const confirmacion = confirm("⚠️ ¿Estás SEGURO de que quieres eliminar TODAS las asistencias? Esta acción no se puede deshacer.");
        
        if (confirmacion) {
          const deleteButton = document.getElementById('deleteButton');
          const resultsDiv = document.getElementById('results');
          const messageDiv = document.getElementById('message');
          const totalCountSpan = document.getElementById('totalCount');

          deleteButton.disabled = true;
          deleteButton.innerHTML = '<i class="fas fa-trash spinner mr-2"></i> Eliminando...';
          messageDiv.classList.add('hidden');

          try {
            const querySnapshot = await getDocs(collection(db, "asistencias"));
            
            if (querySnapshot.empty) {
              messageDiv.textContent = 'La base de datos ya está vacía.';
              messageDiv.classList.remove('hidden');
              return;
            }
            
            const deletePromises = [];
            querySnapshot.forEach((docSnapshot) => {
              deletePromises.push(deleteDoc(doc(db, "asistencias", docSnapshot.id)));
            });

            await Promise.all(deletePromises);

            resultsDiv.innerHTML = '';
            document.getElementById('copyButton').classList.add('hidden');
            messageDiv.className = "p-4 mb-8 text-sm font-medium rounded-lg border bg-green-100 border-green-500 text-green-800";
            messageDiv.textContent = '✅ ¡Todas las asistencias han sido eliminadas correctamente!';
            totalCountSpan.textContent = 'Total: 0'; 

          } catch (error) {
            messageDiv.className = "p-4 mb-8 text-sm font-medium rounded-lg border bg-red-100 border-red-500 text-red-800";
            messageDiv.textContent = '❌ Error al eliminar los datos: ' + error.message;
            console.error("Error deleting documents: ", error);
          } finally {
            deleteButton.disabled = false;
            deleteButton.innerHTML = '<i class="fas fa-eraser mr-2"></i> Eliminar asistencias';
          }
        }
      } else {
        alert("Contraseña incorrecta. No se realizaron cambios.");
      }
    }

    // Asignar eventos a los botones
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('loadButton').addEventListener('click', cargarAsistencias);
      document.getElementById('copyButton').addEventListener('click', copiarDatos);
      document.getElementById('deleteButton').addEventListener('click', eliminarAsistencias);
      document.getElementById('resetFilterButton').addEventListener('click', resetFilters); // Evento para limpiar filtros
      
      // Establecer los iconos iniciales en los botones
      document.getElementById('loadButton').innerHTML = '<i class="fas fa-download mr-2"></i> Cargar Asistencias';
      document.getElementById('copyButton').innerHTML = '<i class="fas fa-copy mr-2"></i> Copiar como CSV';
      document.getElementById('deleteButton').innerHTML = '<i class="fas fa-eraser mr-2"></i> Eliminar asistencias';
    });
  </script>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">
  <div class="max-w-5xl mx-auto bg-white p-8 rounded-xl shadow-2xl border border-gray-200">
    
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4">
      <h1 class="text-3xl font-extrabold text-gray-800 flex items-center">
        <i class="fas fa-chart-bar text-blue-500 mr-3"></i> Gestión de Asistencias
      </h1>
      <span id="totalCount" class="text-2xl font-bold text-blue-600 mt-2 sm:mt-0 px-4 py-1 bg-blue-50 rounded-lg border border-blue-200"></span> 
    </div>

        <p class="text-gray-600 mb-8">Esta herramienta te permite **exportar y gestionar** los datos de asistencia de tu base de datos en Firebase Firestore. La exportación se realiza en formato CSV, ideal para hojas de cálculo.</p>
   
    <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-200 shadow-md mb-8">
        <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
            <i class="fas fa-calendar-alt text-yellow-600 mr-2"></i> Filtrar por Fecha y Hora
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-end">
            <div>
                <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha Desde:</label>
                <input type="date" id="startDate" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm">
            </div>
            <div>
                <label for="startTime" class="block text-sm font-medium text-gray-700 mb-1">Hora Desde:</label>
                <input type="time" id="startTime" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm">
            </div>

            <div>
                <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha Hasta:</label>
                <input type="date" id="endDate" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm">
            </div>
            <div>
                <label for="endTime" class="block text-sm font-medium text-gray-700 mb-1">Hora Hasta:</label>
                <input type="time" id="endTime" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm">
            </div>
        </div>
        
        <div class="flex justify-start mt-4">
             <button id="resetFilterButton" class="flex items-center justify-center bg-gray-500 text-white font-semibold py-2 px-4 rounded-xl hover:bg-gray-600 transition duration-300 transform hover:scale-105 shadow-md">
                <i class="fas fa-undo mr-2"></i> Limpiar Filtros
            </button>
        </div>
        <p class="text-sm text-gray-500 mt-3 italic">Selecciona el rango de tiempo y haz clic en "Cargar Asistencias" para aplicar el filtro.</p>
    </div>
    
        <div class="flex flex-wrap items-center gap-4 mb-10 p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-inner">
            <button id="loadButton" class="flex items-center justify-center bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition duration-300 transform hover:scale-105 shadow-lg shadow-blue-300/50">
      </button>
      
            <button id="copyButton" class="hidden flex items-center justify-center bg-green-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-green-700 transition duration-300 transform hover:scale-105 shadow-lg shadow-green-300/50">
      </button>
      
            <button id="deleteButton" class="flex items-center justify-center bg-red-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-red-700 transition duration-300 transform hover:scale-105 shadow-lg shadow-red-300/50 ml-auto">
      </button>
    </div>

        <div id="message" class="hidden p-4 mb-8 text-sm font-medium rounded-lg border"></div>

        <div id="results" class="overflow-x-auto mt-8">
    </div>
  </div>
</body>
</html>
