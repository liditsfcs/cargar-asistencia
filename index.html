<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asistencia FCS</title>
  <!-- Tailwind CSS para un diseño moderno y responsivo -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts para una tipografía más agradable -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Estilo base para la fuente y el color de fondo */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0f9ff; /* Un azul cielo muy claro */
    }
    /* Estilos para las transiciones y sombras de los botones */
    .btn {
      transition: all 0.2s ease-in-out;
    }
    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
  </style>
  <script type="module">
    // Importar funciones de Firebase v10
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { 
      getAuth, 
      GoogleAuthProvider, 
      signInWithRedirect,
      signOut, 
      onAuthStateChanged,
      getRedirectResult,
      setPersistence,
      browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    // Tu configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCxTeZ8LvP4YMKCV3Ter2n1_Wej0ezYgBQ",
      authDomain: "asistencia-d15e0.firebaseapp.com",
      projectId: "asistencia-d15e0",
      storageBucket: "asistencia-d15e0.firebasestorage.app",
      messagingSenderId: "588035080507",
      appId: "1:588035080507:web:76ff418bb86fccafb0b71e",
      measurementId: "G-7XQHD1MG9G"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // --- Constantes de la aplicación ---
    const latAula = -32.48024900029567;
    const lonAula = -58.26212864336707;
    const radioPermitido = 25;

    // --- Elementos del DOM ---
    let loginButton, logoutButton, attendanceButton, statusDiv, messageDiv, userInfoDiv, mainCard, loadingSpinner;

    // Se ejecuta cuando el DOM está completamente cargado
    document.addEventListener('DOMContentLoaded', () => {
        loginButton = document.getElementById("loginButton");
        logoutButton = document.getElementById("logoutButton");
        attendanceButton = document.getElementById("btnAsistencia");
        statusDiv = document.getElementById("status");
        messageDiv = document.getElementById("message");
        userInfoDiv = document.getElementById("userInfo");
        mainCard = document.getElementById("mainCard");
        loadingSpinner = document.getElementById('loadingSpinner');

        loginButton.addEventListener('click', login);
        logoutButton.addEventListener('click', logout);
        attendanceButton.addEventListener('click', registrarAsistencia);
        
        // Procesa el resultado de la redirección al cargar la página.
        // La actualización de la interfaz de usuario se manejará en onAuthStateChanged.
        getRedirectResult(auth)
          .then((result) => {
            if (result) {
              showMessage("¡Login exitoso!");
            }
          }).catch((error) => {
            showMessage(`Error en el login: ${error.message}`, true);
          });
    });

    // --- Lógica de Autenticación ---

    // onAuthStateChanged es ahora la única fuente de verdad para el estado de la UI.
    // Se ejecuta al cargar la página y después de cualquier cambio de autenticación.
    onAuthStateChanged(auth, user => {
      // Como el estado de autenticación ya se conoce, podemos mostrar la app.
      loadingSpinner.classList.add('hidden');
      mainCard.classList.remove('hidden');

      if (user) {
        // Usuario logueado: muestra su información y habilita los botones.
        userInfoDiv.innerHTML = `
          <img src="${user.photoURL}" alt="Foto de perfil" class="w-12 h-12 rounded-full mx-auto mb-2 border-2 border-sky-200">
          <p class="font-semibold text-gray-800">${user.displayName}</p>
          <p class="text-sm text-gray-500">${user.email}</p>
        `;
        statusDiv.classList.add('hidden');
        userInfoDiv.classList.remove('hidden');
        loginButton.classList.add('hidden');
        logoutButton.classList.remove('hidden');
        attendanceButton.disabled = false;
      } else {
        // Usuario no logueado: muestra el botón de login.
        statusDiv.classList.remove('hidden');
        userInfoDiv.classList.add('hidden');
        loginButton.classList.remove('hidden');
        logoutButton.classList.add('hidden');
        attendanceButton.disabled = true;
      }
    });

    // MODIFICADO: Establece la persistencia justo antes de redirigir.
    const login = async () => {
      try {
        await setPersistence(auth, browserLocalPersistence);
        await signInWithRedirect(auth, provider);
      } catch (e) {
        showMessage("Error al iniciar el login: " + e.message, true);
      }
    };

    const logout = async () => {
      await signOut(auth);
    };

    // --- Lógica de Asistencia (sin cambios) ---
    const registrarAsistencia = () => {
      const user = auth.currentUser;
      if (!user) {
        showMessage("Debes iniciar sesión primero.", true);
        return;
      }
      showMessage("Obteniendo tu ubicación...", false, true);
      attendanceButton.disabled = true;
      navigator.geolocation.getCurrentPosition(async pos => {
        const d = calcularDistancia(latAula, lonAula, pos.coords.latitude, pos.coords.longitude);
        if (d > radioPermitido) {
          showMessage(`❌ No estás en el aula. Distancia: ${d.toFixed(0)} metros.`, true);
          attendanceButton.disabled = false;
          return;
        }
        const uid = user.uid;
        const docRef = doc(db, "asistencias", uid);
        const ahora = new Date();
        try {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
              const data = docSnap.data();
              if (ahora.getTime() < data.bloqueadoHasta) {
                const falta = Math.round((data.bloqueadoHasta - ahora.getTime()) / 60000);
                showMessage(`⚠️ Ya registraste. Espera ${falta} min.`, true);
                attendanceButton.disabled = false;
                return;
              }
            }
            await setDoc(docRef, {
              uid: uid,
              nombre: user.displayName,
              email: user.email,
              timestamp: ahora.getTime(),
              fechaHora: ahora.toLocaleString('es-AR', { dateStyle: 'medium', timeStyle: 'short' }),
              bloqueadoHasta: ahora.getTime() + 10 * 60 * 1000
            });
            showMessage("✅ ¡Asistencia registrada correctamente!");
            attendanceButton.disabled = false;
        } catch (error) {
            showMessage("Error al guardar en la base de datos.", true);
            console.error("Error writing document: ", error);
            attendanceButton.disabled = false;
        }
      }, err => {
        showMessage("Error de GPS. Asegúrate de activarlo y dar permisos.", true);
        attendanceButton.disabled = false;
      }, { enableHighAccuracy: true });
    };

    // --- Funciones de Utilidad (sin cambios) ---
    function showMessage(msg, isError = false, isPersistent = false) {
      messageDiv.textContent = msg;
      messageDiv.className = 'p-3 rounded-md text-sm text-center font-medium';
      if (isError) {
        messageDiv.classList.add('bg-red-100', 'text-red-800');
      } else {
        messageDiv.classList.add('bg-green-100', 'text-green-800');
      }
      messageDiv.classList.remove('hidden');
      if (!isPersistent) {
        setTimeout(() => {
          messageDiv.classList.add('hidden');
        }, 5000);
      }
    }
    function calcularDistancia(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const phi1 = lat1 * Math.PI / 180;
      const phi2 = lat2 * Math.PI / 180;
      const deltaPhi = (lat2 - lat1) * Math.PI / 180;
      const deltaLambda = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(deltaPhi / 2) ** 2 + Math.cos(phi1) * Math.cos(phi2) * Math.sin(deltaLambda / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }
  </script>
</head>
<body class="flex items-center justify-center min-h-screen">

  <!-- Spinner de carga inicial -->
  <div id="loadingSpinner" class="text-center">
    <svg class="animate-spin h-10 w-10 text-sky-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <p class="mt-2 text-gray-600">Cargando...</p>
  </div>

  <!-- Tarjeta principal de la aplicación -->
  <div id="mainCard" class="w-full max-w-sm mx-auto bg-white rounded-2xl shadow-xl p-8 text-center hidden">
    
    <!-- Logo -->
    <img src="https://pbs.twimg.com/profile_images/1323229344563646465/UdNYE4y9_400x400.jpg" alt="Logo FCS" class="w-24 h-24 mx-auto mb-4 rounded-full">
    
    <h1 class="text-2xl font-bold text-gray-800 mb-2">Registro de Asistencia</h1>
    <p class="text-gray-500 mb-6">Facultad de Ciencias de la Salud</p>
    
    <!-- Contenedor para mensajes -->
    <div id="message" class="hidden mb-4"></div>

    <!-- Información del usuario o estado de login -->
    <div id="status" class="mb-6 text-gray-600">Inicia sesión para continuar</div>
    <div id="userInfo" class="hidden mb-6"></div>
    
    <!-- Botones de acción -->
    <div class="space-y-3">
      <button id="loginButton" class="btn w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-sky-700">
        Login con Google
      </button>

      <button id="btnAsistencia" class="btn w-full bg-emerald-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-emerald-600 disabled:bg-gray-300 disabled:cursor-not-allowed disabled:shadow-none disabled:transform-none" disabled>
        Registrar mi asistencia
      </button>

      <button id="logoutButton" class="btn hidden w-full bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 text-sm">
        Cerrar Sesión
      </button>
    </div>
  </div>

</body>
</html>
