<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exportar Asistencias</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    #results pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
  <script type="module">
    // Importar funciones de Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // ¡IMPORTANTE! Usa la misma configuración que tu app de asistencia
    const firebaseConfig = {
      apiKey: "AIzaSyCxTeZ8LvP4YMKCV3Ter2n1_Wej0ezYgBQ",
      authDomain: "asistencia-d15e0.firebaseapp.com",
      projectId: "asistencia-d15e0",
      storageBucket: "asistencia-d15e0.firebasestorage.app",
      messagingSenderId: "588035080507",
      appId: "1:588035080507:web:76ff418bb86fccafb0b71e",
      measurementId: "G-7XQHD1MG9G"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Lógica para cargar y mostrar datos ---
    async function cargarAsistencias() {
      const loadButton = document.getElementById('loadButton');
      const copyButton = document.getElementById('copyButton');
      const resultsDiv = document.getElementById('results');
      const messageDiv = document.getElementById('message');

      loadButton.disabled = true;
      loadButton.textContent = 'Cargando...';
      resultsDiv.innerHTML = '';
      messageDiv.classList.add('hidden');

      try {
        // Obtenemos todos los documentos de la colección "asistencias"
        const querySnapshot = await getDocs(collection(db, "asistencias"));
        
        if (querySnapshot.empty) {
          messageDiv.textContent = 'No se encontraron registros de asistencia.';
          messageDiv.classList.remove('hidden');
          return;
        }

        let formattedData = "Nombre;Email;Fecha y Hora\n"; // Encabezados para formato CSV
        let htmlData = `
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50"><tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha y Hora</th>
            </tr></thead>
            <tbody class="bg-white divide-y divide-gray-200">
        `;

        querySnapshot.forEach((doc) => {
          const data = doc.data();
          // Añadimos los datos a nuestras cadenas de texto
          formattedData += `"${data.nombre}";"${data.email}";"${data.fechaHora}"\n`;
          htmlData += `<tr>
            <td class="px-6 py-4 whitespace-nowrap">${data.nombre}</td>
            <td class="px-6 py-4 whitespace-nowrap">${data.email}</td>
            <td class="px-6 py-4 whitespace-nowrap">${data.fechaHora}</td>
          </tr>`;
        });

        htmlData += `</tbody></table>`;
        resultsDiv.innerHTML = htmlData; // Mostramos la tabla bonita
        
        // Guardamos los datos en formato CSV en un atributo para el botón de copiar
        resultsDiv.dataset.csv = formattedData;
        copyButton.classList.remove('hidden');

      } catch (error) {
        messageDiv.textContent = 'Error al cargar los datos: ' + error.message;
        messageDiv.classList.remove('hidden');
        console.error("Error fetching documents: ", error);
      } finally {
        loadButton.disabled = false;
        loadButton.textContent = 'Cargar Asistencias';
      }
    }

    // --- Lógica para copiar ---
    function copiarDatos() {
        const resultsDiv = document.getElementById('results');
        const copyButton = document.getElementById('copyButton');
        const csvData = resultsDiv.dataset.csv;

        // Usamos una técnica compatible para copiar al portapapeles
        const textArea = document.createElement("textarea");
        textArea.value = csvData;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            copyButton.textContent = '¡Copiado!';
        } catch (err) {
            console.error('No se pudo copiar', err);
        }
        document.body.removeChild(textArea);
        setTimeout(() => { copyButton.textContent = 'Copiar como CSV (para Excel)'; }, 2000);
    }

    // Asignar eventos a los botones cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('loadButton').addEventListener('click', cargarAsistencias);
      document.getElementById('copyButton').addEventListener('click', copiarDatos);
    });
  </script>
</head>
<body class="bg-gray-50 p-4 sm:p-8">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
    <h1 class="text-2xl font-bold text-gray-800 mb-4">Exportador de Asistencias</h1>
    <p class="text-gray-600 mb-6">Esta herramienta lee los datos de tu colección 'asistencias' en Firestore y los muestra en una tabla. Luego puedes copiarlos en formato CSV para pegarlos fácilmente en una hoja de cálculo como Excel o Google Sheets.</p>
    
    <div class="flex space-x-4 mb-6">
      <button id="loadButton" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Cargar Asistencias</button>
      <button id="copyButton" class="hidden bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition">Copiar como CSV (para Excel)</button>
    </div>

    <div id="message" class="hidden p-3 mb-4 bg-yellow-100 text-yellow-800 rounded-md"></div>

    <div id="results" class="overflow-x-auto">
      <!-- Los resultados de la base de datos se mostrarán aquí -->
    </div>
  </div>
</body>
</html>
